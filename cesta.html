<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Tu Cesta - Creaciones Mary</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Poppins,sans-serif;background:#faf7f2;color:#3d2b1f;scroll-behavior:smooth;line-height:1.4}
header{display:flex;justify-content:center;align-items:center;position:fixed;top:0;width:100%;background:#3d2b1f;color:white;padding:15px 20px;z-index:20;box-shadow:0 4px 10px rgba(0,0,0,.2);}
header h1{font-size:1.5rem;cursor:pointer;margin:0;}
#cestaList{max-width:700px;margin:110px auto 20px;padding:15px;display:flex;flex-direction:column;gap:15px}
.cestaItem{background:white;padding:15px;border-radius:15px;box-shadow:0 5px 15px rgba(0,0,0,.1);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;transition:0.3s}
.cestaItem:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,.15)}
.cestaItem img{width:80px;height:80px;border-radius:12px;object-fit:cover;margin-right:15px}
.cestaItem h4{margin-bottom:5px;font-size:1.1rem}
.cestaItem p{font-weight:500;color:#555}
.cestaItem input{width:60px;text-align:center;margin:0 5px;padding:5px;border-radius:8px;border:1px solid #ccc}
.cestaItem button{background:#3d2b1f;color:white;border:none;border-radius:10px;padding:6px 12px;cursor:pointer;transition:.3s;font-size:0.9rem}
.cestaItem button:hover{background:#5a3d2f}
#totalCesta{text-align:right;font-weight:bold;font-size:1.3rem;margin-top:10px;max-width:700px;margin-left:auto;margin-right:auto}
#openModalBtn{display:block;margin:20px auto;background:#3d2b1f;color:white;padding:12px 25px;border:none;border-radius:50px;cursor:pointer;transition:0.3s;font-size:1rem}
#openModalBtn:hover{background:#5a3d2f}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:50;opacity:0;transition:opacity 0.3s ease}
.modal.show{display:flex;opacity:1}
.modal-content{background:white;padding:25px;border-radius:15px;max-width:400px;width:90%;text-align:center;position:relative;transform:translateY(-50px);transition:transform 0.3s ease}
.modal.show .modal-content{transform:translateY(0)}
.modal h2{margin-bottom:15px;font-size:1.4rem;color:#3d2b1f}
.modal input{width:100%;padding:12px;margin:10px 0;border-radius:10px;border:1px solid #ccc;font-size:1rem}
.modal button{background:#3d2b1f;color:white;border:none;padding:12px;border-radius:50px;cursor:pointer;transition:.3s;font-size:1rem;margin-top:10px;width:100%}
.modal button:hover{background:#5a3d2f}
.modal-close{position:absolute;top:10px;right:15px;font-size:22px;cursor:pointer;color:#3d2b1f;font-weight:bold}
.toast-container{position:fixed;top:20px;right:20px;z-index:999;display:flex;flex-direction:column;gap:10px}
.toast{background:#3d2b1f;color:white;padding:12px 20px;border-radius:12px;box-shadow:0 5px 15px rgba(0,0,0,.2);opacity:0;transform:translateX(100%);animation:slideIn 0.5s forwards, slideOut 0.5s forwards 3s}
@keyframes slideIn{to{opacity:1;transform:translateX(0)}}@keyframes slideOut{to{opacity:0;transform:translateX(100%)}} 
@media(max-width:500px){.cestaItem{flex-direction:column;}.cestaItem img{margin-bottom:10px}#totalCesta{text-align:center}.toast-container{top:10px;right:10px}}
</style>
</head>
<body>

<header><h1>Creaciones Mary</h1></header>

<div id="cestaList"></div>
<div id="totalCesta"></div>

<!-- Solo bot√≥n de enviar pedido -->
<button id="openModalBtn" onclick="abrirModal()">Enviar pedido</button>

<!-- Modal de ingreso de datos -->
<div id="pedidoModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="cerrarModal()">&times;</span>
    <h2>Datos de env√≠o</h2>
    <input id="modalNombre" placeholder="Nombre completo">
    <input id="modalDireccion" placeholder="Direcci√≥n exacta">
    <button onclick="confirmarPedido()">Enviar</button>
  </div>
</div>

<!-- Modal de confirmaci√≥n de factura -->
<div id="facturaModal" class="modal">
  <div class="modal-content">
    <h2>¬øDeseas recibir la factura de tu pedido?</h2>
    <div style="display:flex;justify-content:center;gap:20px;margin-top:25px;flex-wrap:wrap;">
      <button onclick="enviarConFactura()" style="background:#3d2b1f;color:white;padding:12px 25px;border-radius:50px;border:none;cursor:pointer;font-size:1rem;">S√≠, descargar factura</button>
      <button onclick="enviarSinFactura()" style="background:#5a3d2f;color:white;padding:12px 25px;border-radius:50px;border:none;cursor:pointer;font-size:1rem;">No, solo enviar pedido</button>
    </div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const { jsPDF } = window.jspdf;
let carrito = JSON.parse(localStorage.getItem('car')||'[]');

function renderCesta(){
  let lista = document.getElementById('cestaList'); lista.innerHTML='';
  let total=0;
  carrito.forEach((p,i)=>{
    total += p.p*(p.cantidad||1);
    lista.innerHTML += `<div class="cestaItem">
      <img src="${p.img}" alt="${p.n}">
      <div style="flex:1;">
        <h4>${p.n}</h4>
        <p>C$${p.p}</p>
      </div>
      <div>
        <input type="number" min="1" value="${p.cantidad||1}" onchange="updateCantidad(${i},this.value)">
        <button onclick="eliminar(${i})">Eliminar</button>
      </div>
    </div>`;
  });
  document.getElementById('totalCesta').innerText = "Total: C$"+total;
  localStorage.setItem('car',JSON.stringify(carrito));
}

function updateCantidad(index,value){ carrito[index].cantidad=parseInt(value); renderCesta(); }
function eliminar(index){ carrito.splice(index,1); renderCesta(); }

const modal = document.getElementById('pedidoModal');
const facturaModal = document.getElementById('facturaModal');

function abrirModal(){ modal.classList.add('show'); }
function cerrarModal(){ modal.classList.remove('show'); }

function showToast(message){
  const container=document.getElementById('toastContainer');
  const toast=document.createElement('div'); 
  toast.className='toast'; 
  toast.innerText=message;
  container.appendChild(toast); 
  setTimeout(()=>{ container.removeChild(toast); },4000);
}

async function toBase64Image(url){
  return new Promise((resolve,reject)=>{
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.src = url;
    img.onload = ()=>{ 
      const canvas=document.createElement("canvas");
      canvas.width = img.width; canvas.height = img.height;
      canvas.getContext("2d").drawImage(img,0,0);
      resolve(canvas.toDataURL("image/jpeg"));
    };
    img.onerror = e=>reject(e);
  });
}

async function generarFactura(){
  if(carrito.length==0){ showToast("El carrito est√° vac√≠o"); return; }
  const doc = new jsPDF();
  const fecha = new Date();

  doc.setFillColor(245, 222, 179);
  doc.rect(10, 10, 190, 20, 'F');
  doc.setFontSize(18); doc.setTextColor(61,43,31);
  doc.text("Creaciones Mary", 105, 25, null, null, 'center');

  doc.setFontSize(12); doc.setTextColor(0,0,0);
  doc.text(`Fecha: ${fecha.toLocaleDateString()}  Hora: ${fecha.toLocaleTimeString()}`, 14, 40);
  doc.setLineWidth(0.5); doc.line(14,44,196,44);

  let y=50; doc.setFontSize(12);
  for(let i=0; i<carrito.length; i++){
    const p = carrito[i];
    doc.rect(14, y-3, 180, 30);
    try{
      const imgData = await toBase64Image(p.img); 
      doc.addImage(imgData, 'JPEG', 16, y-2, 18, 18);
    }catch(e){ console.log("Error cargando imagen:", e); }
    doc.text(`${i+1}. ${p.n}`, 40, y+10);
    doc.text(`C$${p.p}`, 100, y+10);
    doc.text(`x${p.cantidad||1}`, 140, y+10);
    doc.text(`C$${p.p*(p.cantidad||1)}`, 170, y+10);
    y += 35;
  }

  const total = carrito.reduce((acc,p)=>acc+p.p*(p.cantidad||1),0);
  doc.setFontSize(14); doc.setTextColor(61,43,31);
  doc.text(`Total: C$${total}`, 150, y+10);

  doc.save("Factura_CreacionesMary.pdf");
  showToast("‚úÖ Factura descargada autom√°ticamente");
}

async function confirmarPedido(){
  let n = document.getElementById('modalNombre').value.trim();
  let d = document.getElementById('modalDireccion').value.trim();

  // Validaci√≥n del nombre: solo letras y espacios, m√≠nimo 3 caracteres
  if(!/^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]{3,}$/.test(n)){
    showToast("‚ùå Ingresa un nombre v√°lido");
    return;
  }

  // Validaci√≥n de direcci√≥n: m√≠nimo 5 caracteres
  if(d.length < 5){
    showToast("‚ùå Ingresa una direcci√≥n v√°lida");
    return;
  }

  cerrarModal();
  facturaModal.classList.add('show');
  facturaModal.dataset.nombre = n;
  facturaModal.dataset.direccion = d;
}

async function enviarConFactura(){
  const n = facturaModal.dataset.nombre;
  const d = facturaModal.dataset.direccion;
  facturaModal.classList.remove('show');
  await generarFactura();
  enviarWhatsApp(n,d);
}

function enviarSinFactura(){
  const n = facturaModal.dataset.nombre;
  const d = facturaModal.dataset.direccion;
  facturaModal.classList.remove('show');
  enviarWhatsApp(n,d);
}

async function enviarWhatsApp(nombre,direccion){
  let msg = `üì¶ NUEVO PEDIDO%0ACliente: ${nombre}%0ADirecci√≥n: ${direccion}%0A\n`;

  for(let p of carrito){
    try {
      // Convertir imagen a base64
      const imgData = await toBase64Image(p.img);
      msg += `${p.n} - C$${p.p} x${p.cantidad||1}%0AImagen: ${imgData}%0A\n`;
    } catch(e) {
      console.log("Error cargando imagen:", e);
      msg += `${p.n} - C$${p.p} x${p.cantidad||1}%0AImagen: No disponible\n`;
    }
  }

  showToast("‚úÖ Pedido enviado a WhatsApp");

  // Vaciar carrito
  carrito = [];
  localStorage.setItem('car', JSON.stringify(carrito));
  renderCesta();

  setTimeout(()=>{ 
    location.href = "https://wa.me/50582337242?text=" + msg; 
  }, 500);
}

renderCesta();
</script>

</body>
</html>
